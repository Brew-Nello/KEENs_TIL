
## 3 way handshake

- TCP는 장치들 사이에서 논리적인 접속을 성립(establish) 하기 위하여 이 기법을 사용한다.
- TCP/IP 프로토콜을 이용해서 통신을 하는 응용프로그램이 데이터를 전송하기 전에 먼저 정확한 전송을 보장하기 위해 상대방 컴퓨터와 사전에 세션을 수립하는 과정을 의미한다.

```
TCP 접속을 성공적으로 성립하기 위해서는 반드시 필요한 절차이다.
```

> 역할

- 양쪽 모두 데이터를 전송할 준비가 되어있다는 것을 보장하고, 실제로 데이터 전달이 시작하기 전에 한쪽이 다른쪽이 준비되었다는 것을 알 수 있도록 한다.
이 신호가 ACK 이다.

</br>

> 과정

```
클라이언트 > 서버 : TCP SYN
서버 > 클라이언트 : TCP SYN ACK
클라이언트 > 서버 : TCP ACK

* SYN = Synchronize numbers
* ACK = Acknowledgement
```
(1)  
클라이언트는 서버에 접속을 요청하는 `SYN` 패킷을 보낸다.
클라이언트가 `SYN`을 보내고 `SYN`/`ACK` 응답을 기다리는 `SYN_SENT`상태가 된다.

</br>

(2)   
서버는 `SYN` 요청을 받고 클라이언트에게 요청을 수락한다는 `ACK`와 `SYN` 플래그가 설정된 패킷을 발송하고
클라이언트가 다시 `ACK`로 응답하기를 기다린다.
이때 서버는 `SYN_RECEIVED` 상태가 된다.

</br>

(3)   
클라이언트는 서버에게 ACK를 보내고 이후로부터는 연결이 이루어지고 데이터가 오가게 되는 것이다,
이때 서버의 상태는 `ESTABLISHED` 이다.

```
위와 같은 방식으로 통신하는 것이 신뢰성 있는 연결을 맺어준다는 TCP의 3-Way-Handshake 방식이다.
```

</br>
</br>

## 4 way handshake

`3-Way-Handshake`는 TCP의 연결을 초기화할 떄 사용한다면,  
`4-Way-Handshake`는 세션을 종료하기 위해 수행되는 절차이다.

> 과정

(1)  
클라이언트가 연결을 종료하곘다는 `FIN` 플래그를 전송한다.

</br>

(2)  
서버는 일단 확인메세지를 보내고, 자신의 통신이 끝날 때까지 기다리는 데 이 상태가 `TIME_WAIT` 이다.

</br>

(3)  
서버가 통신이 끝났으면 연결이 종료되었다고 클라이언트에게 `FIN` 플래그를 전송한다.

</br>

(4)  
클라이언트는 확인했다는 메세지를 보낸다.

</br>

### Q.  
```
만약 서버에서 FIN을 전송하기 전에 전송한 패킷이 라우팅 지연이나 패킷 유실로 인한 재전송 등으로 인해 FIN 패킷보다 늦게 도착하는 상황이 발생한다면??
```

</br>

### A.  
```
클라이언트에서 세션을 종료시킨 후 뒤늦게 도착하는 패킷이 있다면 이 패킷은 Drop 되고 데이터는 유실된다.
이러한 현상을 대비하여 클라이언트는 서버로부터 FIN을 수신하더라도 일정시간(default 240초) 동안 세션을 남겨놓고 잉여 패킷을 기다리는 과정을 거친다.
이 과정을 "TIME_WAIT" 이라고 한다.
```